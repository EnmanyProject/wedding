/**
 * Chat-style Signup Flow with Bety
 * Version: 2.0.0
 */

class ChatSignup {
    constructor() {
        this.messagesContainer = document.getElementById('chat-messages');
        this.inputArea = document.getElementById('chat-input-area');

        this.currentStep = 0;
        this.formData = {
            email: '',
            password: '',
            name: '',
            gender: '',
            birthdate: ''
        };

        this.betyImages = {
            greeting: '/images/Bety2.png',      // Ïù∏ÏÇ¨
            happy: '/images/Bety1.png',         // ÌñâÎ≥µ
            excited: '/images/Bety4.png',       // Ïã†ÎÇ®
            surprised: '/images/Bety3.png',     // ÎÜÄÎûå
            cheerful: '/images/Bety5.png',      // Ï¶êÍ±∞ÏõÄ
            lovely: '/images/Bety7.png',        // ÏÇ¨Îûë
            wink: '/images/Bety6.png'           // ÏúôÌÅ¨
        };

        this.conversationFlow = [
            // 0: Greeting
            {
                betyMessages: [
                    { text: 'ÏïàÎÖïÌïòÏÑ∏Ïöî! üëã', emotion: 'greeting', delay: 500 },
                    { text: 'Ï†ÄÎäî Î≤†Ìã∞ÏòàÏöî! ÎàÑÍµ¨ÎÇòÏóê Ïò§Ïã† Í±∏ ÌôòÏòÅÌï¥Ïöî üíï', emotion: 'happy', delay: 1500 }
                ],
                inputType: 'continue',
                continueText: 'ÏãúÏûëÌï†Í≤åÏöî!'
            },
            // 1: Email
            {
                betyMessages: [
                    { text: 'Î®ºÏ†Ä Ïù¥Î©îÏùº Ï£ºÏÜåÎ•º ÏïåÎ†§Ï£ºÏÑ∏Ïöî üìß', emotion: 'cheerful', delay: 800 }
                ],
                inputType: 'email',
                placeholder: 'example@email.com',
                validation: (value) => {
                    if (!value) return 'Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) return 'Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº ÌòïÏãùÏù¥ ÏïÑÎãàÏóêÏöî';
                    return null;
                },
                onAnswer: (value) => {
                    this.formData.email = value;
                    return { text: 'Î©ãÏßÑ Ïù¥Î©îÏùºÏù¥ÎÑ§Ïöî! ‚ú®', emotion: 'excited', delay: 600 };
                }
            },
            // 2: Password
            {
                betyMessages: [
                    { text: 'Ïù¥Ï†ú ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî üîí', emotion: 'cheerful', delay: 800 },
                    { text: '8Ïûê Ïù¥ÏÉÅÏúºÎ°ú ÏïàÏ†ÑÌïòÍ≤å ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî!', emotion: 'cheerful', delay: 1200 }
                ],
                inputType: 'password',
                placeholder: 'ÎπÑÎ∞ÄÎ≤àÌò∏ (8Ïûê Ïù¥ÏÉÅ)',
                validation: (value) => {
                    if (!value) return 'ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
                    if (value.length < 8) return '8Ïûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
                    return null;
                },
                onAnswer: (value) => {
                    this.formData.password = value;
                    return { text: 'ÏôÑÎ≤ΩÌï¥Ïöî! ÏïàÏ†ÑÌïòÍ≤å Î≥¥Í¥ÄÌï†Í≤åÏöî üõ°Ô∏è', emotion: 'happy', delay: 600 };
                }
            },
            // 3: Name
            {
                betyMessages: [
                    { text: 'Ïù¥Ï†ú ÎãπÏã†ÏùÑ Î≠êÎùºÍ≥† Î∂ÄÎ•ºÍπåÏöî? üòä', emotion: 'happy', delay: 800 }
                ],
                inputType: 'text',
                placeholder: 'Ïù¥Î¶Ñ ÎòêÎäî ÎãâÎÑ§ÏûÑ',
                validation: (value) => {
                    if (!value) return 'Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
                    if (value.length < 2) return '2Ïûê Ïù¥ÏÉÅ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
                    if (value.length > 10) return '10Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî';
                    return null;
                },
                onAnswer: (value) => {
                    this.formData.name = value;
                    return { text: `${value}Îãò! Ï†ïÎßê Ï¢ãÏùÄ Ïù¥Î¶ÑÏù¥ÏóêÏöî! üíñ`, emotion: 'lovely', delay: 600 };
                }
            },
            // 4: Gender
            {
                betyMessages: [
                    { text: 'ÏÑ±Î≥ÑÏùÑ ÏïåÎ†§Ï£ºÏã§ÎûòÏöî?', emotion: 'cheerful', delay: 800 }
                ],
                inputType: 'gender',
                onAnswer: (value) => {
                    this.formData.gender = value;
                    const genderText = value === 'male' ? 'Î©ãÏßÄÏãúÎÑ§Ïöî' : 'ÏïÑÎ¶ÑÎã§Ïö∞ÏãúÎÑ§Ïöî';
                    return { text: `ÏïåÍ≤†Ïñ¥Ïöî! ${genderText}! üéØ`, emotion: 'wink', delay: 600 };
                }
            },
            // 5: Birthdate
            {
                betyMessages: [
                    { text: 'ÏÉùÎÖÑÏõîÏùºÏùÄ Ïñ∏Ï†úÏÑ∏Ïöî? üéÇ', emotion: 'cheerful', delay: 800 }
                ],
                inputType: 'date',
                onAnswer: (value) => {
                    this.formData.birthdate = value;
                    const birthYear = new Date(value).getFullYear();
                    const age = new Date().getFullYear() - birthYear;
                    return { text: `${age}ÏÇ¥Ïù¥ÏãúÍµ∞Ïöî! ÏôÑÎ≤ΩÌï¥Ïöî! ‚ú®`, emotion: 'excited', delay: 600 };
                }
            },
            // 6: Complete
            {
                betyMessages: [
                    { text: 'Î™®Îì† Ï§ÄÎπÑÍ∞Ä ÎÅùÎÇ¨Ïñ¥Ïöî! üéâ', emotion: 'lovely', delay: 800 },
                    { text: `${this.formData.name}Îãò, Ïù¥Ï†ú ÌäπÎ≥ÑÌïú Ïù∏Ïó∞ÏùÑ Ï∞æÏïÑÎ≥ºÍπåÏöî?`, emotion: 'lovely', delay: 1400 }
                ],
                inputType: 'complete',
                continueText: 'ÏãúÏûëÌïòÍ∏∞'
            }
        ];

        this.init();
    }

    init() {
        console.log('üí¨ Chat Signup initialized');
        this.startConversation();
    }

    async startConversation() {
        await this.processStep(0);
    }

    async processStep(stepIndex) {
        if (stepIndex >= this.conversationFlow.length) {
            this.completeSignup();
            return;
        }

        this.currentStep = stepIndex;
        const step = this.conversationFlow[stepIndex];

        // Show Bety's messages
        for (const msg of step.betyMessages) {
            await this.showBetyMessage(msg.text, msg.emotion, msg.delay);
        }

        // Show input based on type
        this.showInput(step);
    }

    async showBetyMessage(text, emotion, delay = 800) {
        // Show typing indicator
        const typingMsg = this.addMessage('bety', '', emotion, true);

        await this.sleep(delay);

        // Remove typing, show actual message
        typingMsg.remove();
        this.addMessage('bety', text, emotion);

        this.scrollToBottom();
    }

    addMessage(sender, text, emotion = 'happy', isTyping = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;

        if (sender === 'bety') {
            const avatar = document.createElement('div');
            avatar.className = 'bety-avatar';
            avatar.innerHTML = `<img src="${this.betyImages[emotion]}" alt="Î≤†Ìã∞">`;
            messageDiv.appendChild(avatar);
        }

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        if (isTyping) {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            contentDiv.appendChild(typingDiv);
        } else {
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.textContent = text;
            contentDiv.appendChild(bubbleDiv);
        }

        messageDiv.appendChild(contentDiv);
        this.messagesContainer.appendChild(messageDiv);

        return messageDiv;
    }

    showInput(step) {
        this.inputArea.innerHTML = '';

        switch (step.inputType) {
            case 'continue':
            case 'complete':
                this.showContinueButton(step);
                break;
            case 'email':
            case 'password':
            case 'text':
                this.showTextInput(step);
                break;
            case 'gender':
                this.showGenderButtons();
                break;
            case 'date':
                this.showDateInput(step);
                break;
        }
    }

    showTextInput(step) {
        const container = document.createElement('div');
        container.className = 'input-text-container';

        const input = document.createElement('input');
        input.type = step.inputType === 'password' ? 'password' : step.inputType === 'email' ? 'email' : 'text';
        input.className = 'input-text';
        input.placeholder = step.placeholder || '';
        input.autofocus = true;

        const button = document.createElement('button');
        button.className = 'btn-send';
        button.innerHTML = '‚û§';
        button.disabled = true;

        input.addEventListener('input', () => {
            button.disabled = !input.value.trim();
        });

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && input.value.trim()) {
                this.handleTextSubmit(input.value, step);
            }
        });

        button.addEventListener('click', () => {
            this.handleTextSubmit(input.value, step);
        });

        container.appendChild(input);
        container.appendChild(button);
        this.inputArea.appendChild(container);

        setTimeout(() => input.focus(), 100);
    }

    async handleTextSubmit(value, step) {
        const validation = step.validation ? step.validation(value) : null;

        if (validation) {
            alert(validation);
            return;
        }

        // Disable input
        this.inputArea.classList.add('input-loading');

        // Show user's answer
        this.addMessage('user', value);
        this.scrollToBottom();

        await this.sleep(400);

        // Get Bety's response
        const response = step.onAnswer(value);
        await this.showBetyMessage(response.text, response.emotion, response.delay);

        await this.sleep(600);

        // Next step
        this.inputArea.classList.remove('input-loading');
        this.processStep(this.currentStep + 1);
    }

    showGenderButtons() {
        const container = document.createElement('div');
        container.className = 'gender-buttons';

        const maleBtn = document.createElement('button');
        maleBtn.className = 'gender-btn';
        maleBtn.innerHTML = '<span class="icon">üë®</span><span>ÎÇ®ÏÑ±</span>';
        maleBtn.onclick = () => this.handleGenderSelect('male', 'ÎÇ®ÏÑ±');

        const femaleBtn = document.createElement('button');
        femaleBtn.className = 'gender-btn';
        femaleBtn.innerHTML = '<span class="icon">üë©</span><span>Ïó¨ÏÑ±</span>';
        femaleBtn.onclick = () => this.handleGenderSelect('female', 'Ïó¨ÏÑ±');

        container.appendChild(maleBtn);
        container.appendChild(femaleBtn);
        this.inputArea.appendChild(container);
    }

    async handleGenderSelect(value, text) {
        this.inputArea.classList.add('input-loading');

        this.addMessage('user', text);
        this.scrollToBottom();

        await this.sleep(400);

        const step = this.conversationFlow[this.currentStep];
        const response = step.onAnswer(value);
        await this.showBetyMessage(response.text, response.emotion, response.delay);

        await this.sleep(600);

        this.inputArea.classList.remove('input-loading');
        this.processStep(this.currentStep + 1);
    }

    showDateInput(step) {
        const container = document.createElement('div');

        const input = document.createElement('input');
        input.type = 'date';
        input.className = 'input-date';
        input.max = '2010-01-01';

        const button = document.createElement('button');
        button.className = 'btn-action';
        button.textContent = 'ÌôïÏù∏';
        button.disabled = true;

        input.addEventListener('change', () => {
            button.disabled = !input.value;
        });

        button.addEventListener('click', () => {
            this.handleDateSubmit(input.value, step);
        });

        container.appendChild(input);
        container.appendChild(button);
        this.inputArea.appendChild(container);
    }

    async handleDateSubmit(value, step) {
        this.inputArea.classList.add('input-loading');

        const formattedDate = new Date(value).toLocaleDateString('ko-KR');
        this.addMessage('user', formattedDate);
        this.scrollToBottom();

        await this.sleep(400);

        const response = step.onAnswer(value);
        await this.showBetyMessage(response.text, response.emotion, response.delay);

        await this.sleep(600);

        this.inputArea.classList.remove('input-loading');
        this.processStep(this.currentStep + 1);
    }

    showContinueButton(step) {
        const button = document.createElement('button');
        button.className = 'btn-action';
        button.textContent = step.continueText;
        button.onclick = () => this.handleContinue(step);
        this.inputArea.appendChild(button);
    }

    async handleContinue(step) {
        this.inputArea.classList.add('input-loading');

        await this.sleep(400);

        this.inputArea.classList.remove('input-loading');

        if (step.inputType === 'complete') {
            this.completeSignup();
        } else {
            this.processStep(this.currentStep + 1);
        }
    }

    completeSignup() {
        console.log('üéâ Signup completed!');
        console.log('üìù Form Data:', this.formData);

        localStorage.setItem('signupData', JSON.stringify({
            ...this.formData,
            completedAt: new Date().toISOString()
        }));

        // Show success message
        this.inputArea.innerHTML = '';
        const successDiv = document.createElement('div');
        successDiv.className = 'success-message';
        successDiv.innerHTML = `
            <div class="success-icon">üéâ</div>
            <div class="success-text">Í∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏñ¥Ïöî!</div>
        `;
        this.inputArea.appendChild(successDiv);

        setTimeout(() => {
            window.location.href = '/index.html';
        }, 2000);
    }

    scrollToBottom() {
        setTimeout(() => {
            this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
        }, 100);
    }

    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    new ChatSignup();
});
